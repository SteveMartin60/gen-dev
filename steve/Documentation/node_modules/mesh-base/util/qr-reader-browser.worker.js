const makeQrReader  = require('./qr-reader-factory');
const buffferObject = Uint8ClampedArray;
const readQrImage   = makeQrReader(buffferObject, readImage);

//..............................................................................
function readImage(source, callback)
{
    if (source && source.data && source.width && source.height)     
        callback(null, source);
    else
        callback('Invalid source');
}
//..............................................................................

//..............................................................................
function handleMessage(msg)
{
    const {id, data, width, height} = msg.data;

    readQrImage({data, width, height}, function(err, qrData)
    {
        var location = null;
        var data     = null;

        if (qrData)
        {
            location = qrData.location;
            data     = qrData.data;
        }
        
        self.postMessage({id, err, location, data});
    });
}
//..............................................................................

self.addEventListener('message', handleMessage);
//..............................................................................
// From: http://stackoverflow.com/questions/18572365/get-local-ip-of-a-device-in-chrome-extension
//..............................................................................

//..............................................................................
const {util} = cxq;
//..............................................................................

//..............................................................................
const
{
    addProperties
} = util;
//..............................................................................

//..............................................................................
function getHostMachineIPs(callback)
{
    var RTCPeerConnection = window.webkitRTCPeerConnection ||
                            window.mozRTCPeerConnection;

    if (!RTCPeerConnection)
        return callback('No WebRTC');

    var addrs = {};
    var ips   = [];
    addrs["0.0.0.0"] = false;

    var rtc = new RTCPeerConnection({iceServers:[]});
    rtc.createDataChannel('', {reliable:false});
    //..........................................................................
    function addAddress(ip)
    {
        if (ips.indexOf(ip) == -1) // avoid duplicate entries (tcp/udp)
            ips.push(ip);
    }
    //..........................................................................
    function processCandidate(evt)
    {
        // convert the candidate to SDP so we can run it through our general parser
        // see https://twitter.com/lancestout/status/525796175425720320 for details
        if (evt.candidate)
        {
            var ip = /^candidate:.+ (\S+) \d+ typ/.exec(evt.candidate.candidate)[1];
            if (ip)
                addAddress(ip);
        }
        else
        {
            // No more candidates
            callback(null, ips);
        }
    }
    ////////////////////////////////////////////////////////////////////////////
    rtc.onicecandidate = processCandidate;
    rtc.createOffer
    (
        function(offerDesc)
        {
            rtc.setLocalDescription(offerDesc);
        },
        function(e)
        {
            console.warn('offer failed', e);
        }
    );
}
//..............................................................................

addProperties(util,
{
    getHostMachineIPs
});

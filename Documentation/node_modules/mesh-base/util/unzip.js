var yauzl = require('yauzl');

//..............................................................................
const {fs, path, util} = cxq;
//..............................................................................

//..............................................................................
const
{
    addProperties,
    forceDirectorySync,
    isString
} = util;
//..............................................................................

//..............................................................................
function simpleUnzip(sourceZipPath, targetFolderPath, prefix, callback)
{
    //Need to remove the prefix from every file

    yauzl.open(sourceZipPath, function(err, zipfile)
    {
        if (err)
            return callback(err);

        zipfile.on('close', function()
        {
            callback(null);
        });

        zipfile.on('error', function(err)
        {
            callback(err);
        });

        zipfile.on('entry', function(entry)
        {
            if (/\/$/.test(entry.fileName))
            {
                // directory file names end with '/'
                return;
            }

            var originalFilename = entry.fileName;
            var filename = originalFilename;
            if (prefix && isString(prefix))
            {
                if (originalFilename.slice(0, prefix.length) == prefix)
                {
                    filename = originalFilename.slice(prefix.length);
                }
                else
                {
                    console.error('unexpected_File_Prefix. Expecting['+prefix+ '] in:',originalFilename);
                }
            }

            var targetFilePath = path.join(targetFolderPath,filename);
            //console.log('zipEntry:', prefix, originalFilename, ' => ', targetFilePath);

            forceDirectorySync(path.dirname(targetFilePath));
            zipfile.openReadStream(entry, function(err, readStream)
            {
                if (err)
                    return callback(err);
              //console.log('Adding_unzipped_file:', targetFilePath);
                readStream.pipe(fs.createWriteStream(targetFilePath));
            });
        });
    });
}
//..............................................................................

addProperties(util,
{
    unzip : simpleUnzip
});

module.exports = simpleUnzip;
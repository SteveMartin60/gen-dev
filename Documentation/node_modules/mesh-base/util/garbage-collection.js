//..............................................................................
const {util} = cxq;
//..............................................................................

//..............................................................................
const
{
    addProperties,
    getMemoryUsage,
    isFunction,
    padLeft,
    round1000,
} = util;
//..............................................................................

//..............................................................................
// Leave this off for normal use, debug use only!!
const allowGarbageCollectionControl = false;
const canRunGarbageCollection       = isFunction(global.gc) && allowGarbageCollectionControl;
//..............................................................................

//..............................................................................
function getMemoryUsageKB()
{
    return round1000(getMemoryUsage()/1024);
}
//..............................................................................

//..............................................................................
function getMemoryUsageMB()
{
    return round1000(getMemoryUsage()/1024/1024);
}
//..............................................................................

//..............................................................................
function showMemory(before, after, caption)
{
    var used = '' + round1000((after-before));
    used = padLeft(used,6);
    console.log(used, after,caption);
}
//..............................................................................

//..............................................................................
function runGarbageCollection()
{
    if (canRunGarbageCollection)
    {
        var memBefore = getMemoryUsageKB();
        gc(true);
        var memAfter  = getMemoryUsageKB();
        showMemory(memBefore, memAfter, 'runGarbageCollection');
    }
    else
    {
        console.log('runGarbageCollection is not available. Run node with --expose-gc option.');
    }
}
//..............................................................................

//..............................................................................
if (canRunGarbageCollection)
{
    runGarbageCollection();
    setInterval(runGarbageCollection, 10000);
}
//..............................................................................

addProperties(util,
{
    canRunGarbageCollection
});


